import numpy as np
import pandas as pd
from sklearn.tree import DecisionTreeRegressor
from sklearn.metrics import mean_squared_error
from sklearn.tree import plot_tree
import matplotlib.pyplot as plt
import os
from sklearn import tree
from sklearn.model_selection import train_test_split
import sys

sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), "..")))

from csdt import CSDT, split_criteria_with_methods

SEED = 0
np.random.seed(SEED)

base_folder = os.getcwd()

from sklearn.metrics.pairwise import euclidean_distances

if __name__ == '__main__':
    ocdt_min_samples_split = 10
    ocdt_min_samples_leaf = 5
    verbose = False

    ocdt_depth = 5
    features_list =['age','sex','bmi','bp','s1','s2','s3','s4','s5','s6']
    target_list = ['target']
    

    df = pd.read_csv(os.path.join(base_folder, "datasets/diabetes_dataset.csv"))
    features_df = df[features_list]
    target_df = df[target_list]
    
    X_train, X_test, y_train, y_test = train_test_split(features_df, target_df, test_size = 0.2, random_state=SEED)
    
    def return_mean(y, x):
        return y.mean(axis=0).astype(np.float64)  

    def calculate_mse(y, predictions,initial_solutions):
        mse = mean_squared_error(y, predictions)
        return np.float64(mse)  
        
    split_criteria = lambda y, x,initial_solutions: split_criteria_with_methods(y, x,pred=return_mean, split_criteria= calculate_mse,initial_solutions=initial_solutions
            )
    
    tree = CSDT(max_depth=ocdt_depth, min_samples_leaf=ocdt_min_samples_leaf, min_samples_split=ocdt_min_samples_split,
                                    split_criteria=split_criteria,
                                    verbose=verbose,use_hashmaps=True,use_initial_solution=True)
    tree.fit(X_train, y_train)
    y_pred = tree.predict(X_test)
    y_pred_df = pd.DataFrame(y_pred)
    y_pred_df['leaf_id'] = tree.apply(X_test)
    y_pred_df = y_pred_df.drop_duplicates()
    ocdt_mse = mean_squared_error(y_test, y_pred)
    print(f'CSDT MSE: {ocdt_mse}')
    
    regressor = DecisionTreeRegressor(random_state=20, min_samples_leaf=ocdt_min_samples_leaf,
                                                min_samples_split=ocdt_min_samples_split, max_depth=ocdt_depth)
    
    regressor.fit(X_train, y_train)
    y_pred_sklearn = regressor.predict(X_test)
    y_pred_sklearn_df = pd.DataFrame(y_pred_sklearn, columns=target_list)
    dt_mse = mean_squared_error(y_test, y_pred_sklearn)
    print(f'Sklearn DT MSE: {dt_mse}')


    output_folder = "results"

    os.makedirs(output_folder, exist_ok=True)

    csdt_output_path = os.path.join(output_folder, 'diabetes_classifier')
    dot = tree.draw_tree()
    dot.render(csdt_output_path, format='png', view=True)

    plt.figure(figsize=(15, 10))
    plot_tree(regressor, filled=True)

    sklearn_output_path = os.path.join(output_folder, 'diabetes_sklearn_dt.png')
    plt.savefig(sklearn_output_path, format='png', dpi=300, bbox_inches='tight')



    


    
   
